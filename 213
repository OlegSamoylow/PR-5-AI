{
 "cells": [
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# Практична робота №5\n",
    "## \"Створення пошукового застосунку на основі текстових вбудовувань\"\n",
    "\n",
    "**Виконав:** [Самойлов Олег Олегович]\n",
    "\n",
    "**Група:** [1К-21]\n",
    "\n",
    "**Варіант індивідуального завдання:** 5\n",
    "\n",
    "**Дата:** 14 грудня 2025 р."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## Мета роботи\n",
    "- Ознайомитися з семантичним пошуком та векторними вбудовуваннями.\n",
    "- Реалізувати пошук за допомогою моделі text-embedding-3-small через GitHub Models.\n",
    "- Виконати індивідуальне завдання: знайти фрагменти про \"Cloud Computing\" та обчислити середню довжину."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## 1. Підключення та підготовка середовища"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 1,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Підключено до GitHub Models (text-embedding-3-small)\n",
      "Токен завантажено: Так\n"
     ]
    }
   ],
   "source": [
    "import os\n",
    "from pathlib import Path\n",
    "\n",
    "import numpy as np\n",
    "import pandas as pd\n",
    "from dotenv import load_dotenv\n",
    "from azure.ai.inference import EmbeddingsClient\n",
    "from azure.core.credentials import AzureKeyCredential\n",
    "\n",
    "load_dotenv()\n",
    "\n",
    "token = os.getenv(\"GITHUB_TOKEN\", \"\")\n",
    "assert token, \"ПОМИЛКА: GITHUB_TOKEN відсутній у файлі .env!\"\n",
    "\n",
    "endpoint = \"https://models.inference.ai.azure.com\"\n",
    "embed_model_name = \"text-embedding-3-small\"\n",
    "\n",
    "SIMILARITY_THRESHOLD = 0.3\n",
    "DATASET_PATH = Path(\"embedding_index_3m.json\")\n",
    "CACHE_PATH = Path(\"embedding_index_githubmodels.json\")\n",
    "BATCH_SIZE = 32\n",
    "\n",
    "embed_client = EmbeddingsClient(\n",
    "    endpoint=endpoint,\n",
    "    credential=AzureKeyCredential(token),\n",
    ")\n",
    "\n",
    "print(\"Підключено до GitHub Models (text-embedding-3-small)\")\n",
    "print(f\"Токен завантажено: {'Так' if token else 'Ні'}\")"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## 2. Завантаження та створення векторного індексу"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Завантаження датасету...\n",
      "Кількість фрагментів у датасеті: 1409\n",
      "Створення/завантаження векторного індексу...\n",
      "Оброблено 1409/1409 фрагментів\n",
      "\n",
      "Генерація завершена.\n",
      "Індекс збережено в кеш: embedding_index_githubmodels.json\n",
      "\n",
      "Індекс готовий. Кількість фрагментів з embedding: 1409\n"
     ]
    }
   ],
   "source": [
    "def load_dataset(source: Path) -> pd.DataFrame:\n",
    "    df = pd.read_json(source).fillna(\"\")\n",
    "    return df.drop(columns=[\"ada_v2\"], errors=\"ignore\")\n",
    "\n",
    "def build_or_load_github_index(df: pd.DataFrame, cache_path: Path | None = None, batch_size: int = 32) -> pd.DataFrame:\n",
    "    if cache_path and cache_path.exists():\n",
    "        cached_df = pd.read_json(cache_path).fillna(\"\")\n",
    "        if \"github_embedding\" in cached_df.columns:\n",
    "            print(f\"Завантажено вбудовування з кешу: {cache_path}\")\n",
    "            return cached_df\n",
    "\n",
    "    summaries = df[\"summary\"].tolist()\n",
    "    embeddings = []\n",
    "\n",
    "    total = len(summaries)\n",
    "    for start in range(0, total, batch_size):\n",
    "        batch = summaries[start:start + batch_size]\n",
    "        response = embed_client.embed(\n",
    "            input=batch,\n",
    "            model=embed_model_name,\n",
    "        )\n",
    "        embeddings.extend([item.embedding for item in response.data])\n",
    "        done = min(start + batch_size, total)\n",
    "        print(f\"Оброблено {done}/{total} фрагментів\", end=\"\\r\")\n",
    "\n",
    "    print(\"\\nГенерація завершена.\")\n",
    "    enriched_df = df.copy()\n",
    "    enriched_df[\"github_embedding\"] = embeddings\n",
    "\n",
    "    if cache_path:\n",
    "        enriched_df.to_json(cache_path, orient=\"records\")\n",
    "        print(f\"Індекс збережено в кеш: {cache_path}\")\n",
    "\n",
    "    return enriched_df\n",
    "\n",
    "# Виконання\n",
    "print(\"Завантаження датасету...\")\n",
    "videos_df = load_dataset(DATASET_PATH)\n",
    "print(f\"Кількість фрагментів у датасеті: {len(videos_df)}\")\n",
    "\n",
    "print(\"Створення/завантаження векторного індексу...\")\n",
    "videos_df = build_or_load_github_index(videos_df, CACHE_PATH, batch_size=BATCH_SIZE)\n",
    "\n",
    "print(f\"\\nІндекс готовий. Кількість фрагментів з embedding: {len(videos_df)}\")"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## 3. Реалізація семантичного пошуку"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "metadata": {},
   "outputs": [],
   "source": [
    "def cosine_similarity(vec_a, vec_b) -> float:\n",
    "    a = np.array(vec_a)\n",
    "    b = np.array(vec_b)\n",
    "    denom = np.linalg.norm(a) * np.linalg.norm(b)\n",
    "    return 0.0 if denom == 0 else float(np.dot(a, b) / denom)\n",
    "\n",
    "def get_query_embedding(query: str):\n",
    "    response = embed_client.embed(\n",
    "        input=[query],\n",
    "        model=embed_model_name,\n",
    "    )\n",
    "    return response.data[0].embedding\n",
    "\n",
    "def get_videos(query: str, video_vectors: pd.DataFrame, rows: int = 5, threshold: float | None = SIMILARITY_THRESHOLD) -> pd.DataFrame:\n",
    "    query_embedding = get_query_embedding(query)\n",
    "    scored = video_vectors.copy()\n",
    "    scored[\"similarity\"] = scored[\"github_embedding\"].apply(lambda emb: cosine_similarity(query_embedding, emb))\n",
    "    scored = scored.sort_values(\"similarity\", ascending=False)\n",
    "    if threshold is not None:\n",
    "        scored = scored[scored[\"similarity\"] >= threshold]\n",
    "    return scored.head(rows)\n",
    "\n",
    "def display_results(videos: pd.DataFrame, query: str):\n",
    "    if videos.empty:\n",
    "        print(f\"\\nНе знайдено релевантних результатів для запиту: '{query}'\\n\")\n",
    "        return\n",
    "\n",
    "    print(f\"\\nТоп-{len(videos)} результатів для запиту: '{query}'\")\n",
    "    for _, row in videos.iterrows():\n",
    "        print(f\"\\n• Спікер: {row['speaker']}\")\n",
    "        print(f\"  Назва: {row['title']}\")\n",
    "        print(f\"  Короткий зміст: {' '.join(row['summary'].split()[:20])}...\")\n",
    "        print(f\"  Подібність: {row['similarity']:.3f}\")"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## 4. Тестування семантичного пошуку"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Топ-5 результатів для запиту: 'Cloud Computing'\n",
      "\n",
      "• Спікер: Gopi Krishna Kumar\n",
      "  Назва: Data Science Virtual Machine\n",
      "  Короткий зміст: Running analytics in the cloud offers several benefits, including repeatable infrastructure, closer proximity to data, enhanced security, and scalability. It...\n",
      "  Подібність: 0.522\n",
      "\n",
      "• Спікер: Phani Mutyala\n",
      "  Назва: Bringing AI to the Edge\n",
      "  Короткий зміст: Customers who are unable to upload all their data to the cloud due to security and privacy concerns, low bandwidth,...\n",
      "  Подібність: 0.512\n",
      "\n",
      "• Спікер: Maksim Luciana\n",
      "  Назва: Azure Machine Learning Compute Instance\n",
      "  Короткий зміст: The video discusses the features of a computing platform that offers infrastructure-as-a-service virtual machines (VMs). Users have access to the...\n",
      "  Подібність: 0.509\n",
      "\n",
      "• Спікер: Vlad Iliescu, Seth Juarez\n",
      "  Назва: How to Draw Anything with Azure AI and Stable Diffusion\n",
      "  Короткий зміст: The video showcases the use of a stable diffusion model on Azure compute instances without any modifications. The presenter highlights...\n",
      "  Подібність: 0.460\n",
      "\n",
      "• Спікер: Maksim Luciana\n",
      "  Назва: Azure Machine Learning Compute Instance\n",
      "  Короткий зміст: Azure Machine Learning Compute Instance allows data scientists to collaborate and share their work seamlessly. By connecting to the machine...\n",
      "  Подібність: 0.429\n",
      "\n",
      "Не знайдено релевантних результатів для запиту: 'хмарні обчислення'\n",
      "\n",
      "Топ-5 результатів для запиту: 'Azure Machine Learning'\n",
      "\n",
      "• Спікер: Chris\n",
      "  Назва: What’s new with Azure Machine Learning\n",
      "  Короткий зміст: Azure Machine Learning is a powerful tool for training and deploying machine learning models. It allows users to create pipelines,...\n",
      "  Подібність: 0.771\n",
      "\n",
      "• Спікер: Parashar Sha\n",
      "  Назва: Introduction to Azure ML Services [Part 1/4]\n",
      "  Короткий зміст: Azure Machine Learning Services offers a range of capabilities for creating and deploying machine learning models. Users can use their...\n",
      "  Подібність: 0.751\n",
      "\n",
      "• Спікер: Santos Pulay\n",
      "  Назва: Azure Machine Learning Pipelines\n",
      "  Короткий зміст: Azure Machine Learning Service allows users to easily set up and run machine learning pipelines. These pipelines consist of discrete...\n",
      "  Подібність: 0.738\n",
      "\n",
      "• Спікер: Chris\n",
      "  Назва: What’s new with Azure Machine Learning\n",
      "  Короткий зміст: Azure Machine Learning offers support for popular frameworks like TensorFlow and PyTorch, allowing users to easily run their code in...\n",
      "  Подібність: 0.735\n",
      "\n",
      "• Спікер: Cesar De la Torre Llorente, Seth\n",
      "  Назва: Build Recap | What’s new in Azure Machine Learning Automated ML\n",
      "  Короткий зміст: Azure Machine Learning has introduced several new features, including AutoML for different tasks such as classification, regression, computer vision, and...\n",
      "  Подібність: 0.732\n",
      "\n",
      "Топ-5 результатів для запиту: 'як запускати моделі в хмарі'\n",
      "\n",
      "• Спікер: Andreas Vrålstad, Seth Juarez\n",
      "  Назва: Tagging Audio using Deep Learning\n",
      "  Короткий зміст: The video demonstrates how to build a model using a platform. The process involves uploading data, building a model from...\n",
      "  Подібність: 0.360\n",
      "\n",
      "• Спікер: Sethu Raman, Seth\n",
      "  Назва: AI Show: Live | Nov 12 | Exciting updates from Managed Online Endpoints from Azure ML | Episode 39\n",
      "  Короткий зміст: The video demonstrates how to safely deploy a model in a Docker container using GitHub Actions for CI/CD. Multiple deployments...\n",
      "  Подібність: 0.355\n",
      "\n",
      "• Спікер: Seth Juarez, John Lam, Rong\n",
      "  Назва: Building a Pet Detector in 30 minutes or less!\n",
      "  Короткий зміст: In this video, the speaker demonstrates how to use the hyperdrive demo to optimize a machine learning model. They show...\n",
      "  Подібність: 0.354\n",
      "\n",
      "• Спікер: Sethu Raman, Seth\n",
      "  Назва: AI Show: Live | Nov 12 | Exciting updates from Managed Online Endpoints from Azure ML | Episode 39\n",
      "  Короткий зміст: To develop a new model, you can change the model itself or the code for feature engineering, scoring, or the...\n",
      "  Подібність: 0.353\n",
      "\n",
      "• Спікер: Seth, Manoj\n",
      "  Назва: AzureML Registries - Enabling Better Collaboration and MLOps\n",
      "  Короткий зміст: The video demonstrates how to register and deploy machine learning models using the Contour ML platform. Users can register models...\n",
      "  Подібність: 0.334\n"
     ]
    }
   ],
   "source": [
    "queries = [\n",
    "    \"Cloud Computing\",\n",
    "    \"хмарні обчислення\",\n",
    "    \"Azure Machine Learning\",\n",
    "    \"як запускати моделі в хмарі\"\n",
    "]\n",
    "\n",
    "for q in queries:\n",
    "    results = get_videos(q, videos_df, rows=5)\n",
    "    display_results(results, q)"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## 5. Індивідуальне завдання (варіант 5)\n",
    "\n",
    "**Завдання:** Виконати пошук фрагментів, у яких згадується \"Cloud Computing\". Порахувати середню довжину цих фрагментів."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Знайдено фрагментів з прямою згадкою 'Cloud Computing': 2\n",
      "\n",
      "Статистика довжини фрагментів:\n",
      "   Середня довжина: 65.50 слів\n",
      "   Мінімальна: 57 слів\n",
      "   Максимальна: 74 слів\n",
      "\n",
      "Приклади:\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>speaker</th>\n",
       "      <th>title</th>\n",
       "      <th>summary</th>\n",
       "      <th>similarity</th>\n",
       "      <th>length_words</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>Shivani Patel, Andy</td>\n",
       "      <td>OSS Framework Support in Azure Machine Learning Service</td>\n",
       "      <td>The video discusses how to run code in different compute environments using Azure Machine Learning. It explains the concept of environments, which are pre-configured packages and dependencies, and how they can be used to easily transition from local to cloud computing. The video also demonstrates an example of running code in a specific environment and compute target.</td>\n",
       "      <td>0.386</td>\n",
       "      <td>57</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>Parinita Rahi, Jessica Cioffi</td>\n",
       "      <td>Deep Learning Container with PyTorch and Azure ML</td>\n",
       "      <td>Azure ML provides pre-validated and pre-installed containers with essential tools and libraries for training machine learning models. These containers include the necessary dependencies, such as specific versions of PyTorch, Python, and CUDA, and have been tested with Microsoft's internal workloads. They also come with training optimization libraries like ORT, DeepSpeed, and MSIKL, making it easie...</td>\n",
       "      <td>0.317</td>\n",
       "      <td>74</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "                        speaker  \\\n",
       "0           Shivani Patel, Andy   \n",
       "1  Parinita Rahi, Jessica Cioffi   \n",
       "\n",
       "                                                     title  \\\n",
       "0  OSS Framework Support in Azure Machine Learning Service   \n",
       "1         Deep Learning Container with PyTorch and Azure ML   \n",
       "\n",
       "                                                                                                                                                                                                                                                                               summary  \\\n",
       "0  The video discusses how to run code in different compute environments using Azure Machine Learning. It explains the concept of environments, which are pre-configured packages and dependencies, and how they can be used to easily transition from local to cloud computing. The video also demonstrates an example of running code in a specific environment and compute target.   \n",
       "1  Azure ML provides pre-validated and pre-installed containers with essential tools and libraries for training machine learning models. These containers include the necessary dependencies, such as specific versions of PyTorch, Python, and CUDA, and have been tested with Microsoft's internal workloads. They also come with training optimization libraries like ORT, DeepSpeed, and MSIKL, making it easie...   \n",
       "\n",
       "   similarity  length_words  \n",
       "0       0.386            57  \n",
       "1       0.317            74  "
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "query_cloud = \"Cloud Computing\"\n",
    "\n",
    "cloud_results = get_videos(query_cloud, videos_df, rows=1000, threshold=None)\n",
    "\n",
    "cloud_mentioned = cloud_results[cloud_results['summary'].str.contains('Cloud Computing', case=False, na=False)]\n",
    "\n",
    "print(f\"Знайдено фрагментів з прямою згадкою 'Cloud Computing': {len(cloud_mentioned)}\")\n",
    "\n",
    "if len(cloud_mentioned) > 0:\n",
    "    cloud_mentioned = cloud_mentioned.copy()\n",
    "    cloud_mentioned['length_words'] = cloud_mentioned['summary'].apply(lambda x: len(x.split()))\n",
    "\n",
    "    avg_length = cloud_mentioned['length_words'].mean()\n",
    "    min_length = cloud_mentioned['length_words'].min()\n",
    "    max_length = cloud_mentioned['length_words'].max()\n",
    "\n",
    "    print(f\"\\nСтатистика довжини фрагментів:\")\n",
    "    print(f\"   Середня довжина: {avg_length:.2f} слів\")\n",
    "    print(f\"   Мінімальна: {min_length} слів\")\n",
    "    print(f\"   Максимальна: {max_length} слів\")\n",
    "\n",
    "    print(\"\\nПриклади:\")\n",
    "    display(cloud_mentioned[['speaker', 'title', 'summary', 'similarity', 'length_words']].head(5))"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## Висновки\n",
    "\n",
    "- Успішно підключено до GitHub Models та створено векторний індекс з 1409 фрагментів.\n",
    "- Реалізовано семантичний пошук з використанням косинусної подібності.\n",
    "- Виконано індивідуальне завдання (варіант 5): знайдено **2 фрагменти** з прямою згадкою \"Cloud Computing\".\n",
    "- Середня довжина таких фрагментів — **65.5 слів**.\n",
    "- Семантичний пошук добре працює з англомовними запитами, але українські запити потребують додаткового налаштування (можливо, через обмежену мультимовність моделі).\n",
    "\n",
    "Робота виконана повністю з використанням сучасного підходу GitHub Models."
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "name": "python",
   "version": "3.12.3"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 4
}
